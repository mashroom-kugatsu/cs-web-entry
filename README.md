# cs-web-entry

メール
貴社名　：株式会社ハラテックス
部署名　：管理部生産技術G
氏　名　：和田敏夫
郵便番号：503-2426
ご住所　：岐阜県揖斐郡池田町八幡1080
電話番号：0585-45-7560

訪問したサービス員氏名
出張者名：小出茂・服部智輝
機番：NS5579
提出日：2020/7/15

訪問したサービス員の対応はいかがでしたか。
1-1　サービス員の服装、身だしなみはいかがでしたか : 5.満足
1-2　サービス員の対応、態度はいかがでしたか : 5.満足
1-3　サービス員の修理技術はどうでしたか : 4.やや満足
1-4　サービス員の作業方法、後片付けはどうでしたか : 5.満足
1-5　サービス員の作業報告はどうでしたか、分かりやすかったですか : 5.満足
1-6　サービス員についてご意見があればお聞かせください :
今回の修理内容だけでなく、他の問題点についても回答がもらえた所がよかった　　過去に他に問題点はないかと聞かれたことはなかった

今回のサービス対応はいかがでしたか。
2-1　お約束の日時にお伺いしましたか : 5.約束通り
2-2　サービスの即応体制は如何でしょうか : 5.満足
2-3　技術料に見合ったサービス対応（段取り、作業、報告）でしたか : 4.やや満足
※2又は1とお応えの場合、理由があればお聞かせ下さい :


サービスコールされた事はありますか。
ある　（あるとお答えの場合下記についてお尋ねします）
3-1　その時のフロント対応はどうでしたか : 4.やや満足
※2又は1とお答えの場合、理由があればお聞かせ下さい :


サービスパーツのご依頼をされた事がありますか。
ある　（あるとお答えの場合下記についてお尋ねします）
4-1　どちらのパーツでしたか : 故障の為の緊急パーツ / 消耗品、保全用の予備パーツ
4-2　パーツの納期はどうでしたか : 2.やや不満
※1,2とお答えの方、希望納期にどれくらいかお聞かせ下さい。
パーツ名　 : ATC関連部品（機械が古いため仕方がない面もあるが）
希望納期 : 3 日以内

サービス活動は他社と比べていかがですか。
他社と比べてはいかがでしたか : 3.同じ
5-1　比較された他社名 : OKK株式会社
5-1　比較された他社名 : DMG森精機
5-2　弊社が良い点（複数回答可） : サービスコール対応
※5項について具体的にコメントがあればお願いします。
電話の対応は早い　他社は２～4時間後ということもある
5-3　弊社が劣る点（複数回答可） : 
※5項について具体的にコメントがあればお願いします。
大きく変わるところはないと思う

サービス全体に関してご意見、ご要望がありましたらお聞かせください。
ご意見、ご要望 :
取説などのトラブルシューティングを充実してもらうと問題発生時の対応・調査がわかりやすくなると思う

当社製品に関してご意見、ご要望がありましたらお聞かせください。
ご意見、ご要望 :

---
JTEKT

カラム1
"id","questionnaire_date","company","division","post","responsible","business_team","business_traveler","kiban","_1C1","_1E1","_1G1","_1I1","_1K1","_1B2","_2C1","_2E1","_2G1","_2B2","_3B1","_3E1","_3D2","_4B1","_4E1","_4G1","_4D2","_4D3","_4D4","_5B1","_5E1","_5C2","_5E2","_5G2","_5I2","_5K2","_5B4","_5C3","_5E3","_5G3","_5I3","_5K3","_5B5","_6A1","_7A1","del_flg","edited","customer_code"
10546,"2020-07-09 00:00:00","株式会社 ｻｲﾒｯｸｽ","第一製造課","","佐野 和彦","SE22","増田　剛","NS2937","5","5","5","5","5","web","5","5","5","","1","5","","0","0","0","","","","5","山崎ﾏｻﾞｯｸ","0","0","1","0","0","","0","0","0","0","0","","","",0,0,"30427"

カラム2
"id","district","model","input_date","serial","no_discount","print_date","use_date","postal","address","tel","old_discount","del_flg","edited"
10546,"西日本ｻﾎﾟｰﾄ","ﾏｼﾆﾝｸﾞ","2020-07-10 00:00:00",1,"0","2020-07-10 00:00:00","1970-01-01 00:00:00","8761512","大分県佐伯市大字堅田3905−5","","S20200710-1",0,0

---
貴社名　：大阪精研株式会社
部署名　：
氏　名　：勝田 善久
郵便番号：5380043
ご住所　：大阪市鶴見区今津南2-1-30
電話番号：0669620552

訪問したサービス員氏名
出張者名：江見昇 中村陽生 蛯名康博
機番：RB7784
提出日：2020年7月21日

訪問したサービス員の対応はいかがでしたか。
1-1　サービス員の服装、身だしなみはいかがでしたか : 5.満足
1-2　サービス員の対応、態度はいかがでしたか : 5.満足
1-3　サービス員の修理技術はどうでしたか : 5.満足
1-4　サービス員の作業方法、後片付けはどうでしたか : 5.満足
1-5　サービス員の作業報告はどうでしたか、分かりやすかったですか : 5.満足
1-6　サービス員についてご意見があればお聞かせください :


今回のサービス対応はいかがでしたか。
2-1　お約束の日時にお伺いしましたか : 5.約束通り
2-2　サービスの即応体制は如何でしょうか : 5.満足
2-3　技術料に見合ったサービス対応（段取り、作業、報告）でしたか : 5.満足
※2又は1とお応えの場合、理由があればお聞かせ下さい :


サービスコールされた事はありますか。
ない
3-1　その時のフロント対応はどうでしたか : 
※2又は1とお答えの場合、理由があればお聞かせ下さい :


サービスパーツのご依頼をされた事がありますか。
ない
4-1　どちらのパーツでしたか : 
4-2　パーツの納期はどうでしたか : 
※1,2とお答えの方、希望納期にどれくらいかお聞かせ下さい。
パーツ名　 : 
希望納期 :  日以内

サービス活動は他社と比べていかがですか。
他社と比べてはいかがでしたか : 5.良い
5-1　比較された他社名 : 
5-1　比較された他社名 : 
5-2　弊社が良い点（複数回答可） : 
※5項について具体的にコメントがあればお願いします。

5-3　弊社が劣る点（複数回答可） : 
※5項について具体的にコメントがあればお願いします。


サービス全体に関してご意見、ご要望がありましたらお聞かせください。
ご意見、ご要望 :


当社製品に関してご意見、ご要望がありましたらお聞かせください。
ご意見、ご要望 :

---
JTEKT


---
貴社名　：(株)フクネツ
部署名　：機械課
氏　名　：菊池　佳治
郵便番号：811-2414
ご住所　：福岡県糟屋郡篠栗町大字和田1034-8
電話番号：092-947-5652

訪問したサービス員氏名
出張者名：増田　剛
機番：NF2974
提出日：2020年7月17日

訪問したサービス員の対応はいかがでしたか。
1-1　サービス員の服装、身だしなみはいかがでしたか : 5.満足
1-2　サービス員の対応、態度はいかがでしたか : 5.満足
1-3　サービス員の修理技術はどうでしたか : 4.やや満足
1-4　サービス員の作業方法、後片付けはどうでしたか : 5.満足
1-5　サービス員の作業報告はどうでしたか、分かりやすかったですか : 5.満足
1-6　サービス員についてご意見があればお聞かせください :


今回のサービス対応はいかがでしたか。
2-1　お約束の日時にお伺いしましたか : 5.約束通り
2-2　サービスの即応体制は如何でしょうか : 5.満足
2-3　技術料に見合ったサービス対応（段取り、作業、報告）でしたか : 3.普通
※2又は1とお応えの場合、理由があればお聞かせ下さい :


サービスコールされた事はありますか。
ある　（あるとお答えの場合下記についてお尋ねします）
3-1　その時のフロント対応はどうでしたか : 4.やや満足
※2又は1とお答えの場合、理由があればお聞かせ下さい :


サービスパーツのご依頼をされた事がありますか。
ある　（あるとお答えの場合下記についてお尋ねします）
4-1　どちらのパーツでしたか : 故障の為の緊急パーツ / 消耗品、保全用の予備パーツ
4-2　パーツの納期はどうでしたか : 3.普通
※1,2とお答えの方、希望納期にどれくらいかお聞かせ下さい。
パーツ名　 : 
希望納期 :  日以内

サービス活動は他社と比べていかがですか。
他社と比べてはいかがでしたか : 
5-1　比較された他社名 : 
5-1　比較された他社名 : 
5-2　弊社が良い点（複数回答可） : 
※5項について具体的にコメントがあればお願いします。

5-3　弊社が劣る点（複数回答可） : 
※5項について具体的にコメントがあればお願いします。


サービス全体に関してご意見、ご要望がありましたらお聞かせください。
ご意見、ご要望 :
いつもお世話になっております。
今年の6/22に油圧ポンプ及びモーターの見積りのご相談をしまして、7/21に商社から回答を頂きました。
上記案件で回答に一か月かかるとは正直思えませし、時間がかかる場合はその旨をアナウンスして頂けると助かりますので、何卒宜しくお願い致します。

当社製品に関してご意見、ご要望がありましたらお聞かせください。
ご意見、ご要望 :

---
JTEKT
--

Sub Macro1()

    Dim wb As Workbook      'ワークブック
    Dim ws As Worksheet     'ワークシート
    Dim companyName As String
    Dim kiban As String
    Dim questionnaireDate As String
    Dim fileDir As String
    Dim fileName As String
    
    '自ワークブック
    Set wb = ThisWorkbook
    'アクティブシート
    Set ws = ActiveSheet

    Worksheets(2).Copy

    Range("A1:C1").Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Copy
    Selection.PasteSpecial Paste:=xlPasteAllUsingSourceTheme, Operation:=xlNone _
        , SkipBlanks:=False, Transpose:=False
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Application.CutCopyMode = False
    
    Columns("D:O").Select
    Selection.Delete Shift:=xlToLeft
    
    companyName = ws.Range("C7").Value
    kiban = ws.Range("C13").Value
    questionnaireDate = Format(Left(ws.Range("C14").Value, 10), "yymmdd")
    
    Debug.Print (questionnaireDate)
    
    fileDir = "\\172.16.38.10\disk1\09_企画G\松川temp\未登録"
    fileName = companyName + kiban + questionnaireDate
    filePath = fileDir + "\" + fileName
    
    ActiveWorkbook.SaveAs filePath
    ActiveWorkbook.Close


End Sub

--受注実績(SP受注も含む)SQL文

\encoding UTF8;

--受注実績
--データコピー
--受注実績17上期～19下期
drop table order_record_17kami_19shimo
;
create table order_record_17kami_19shimo(
    GOKI text,
    JYUR text,
    NOCD text,
    JIKB text,
    CHIK text,
    KIKI text,
    GYOS text,
    KISC text,
    EKIS text,
    SEIH text,
    NAIG text,
    KETE text,
    NOYM text,
    URKB text,
    KENSHU_YOTEI_DATE text,
    JYKN text,
    MITSU_SEIZO_GENKA text,
    TODOFKN_CD text,
    KOKUNAIGAI_KBN text,
    VAL_CHAIN_KBN_CD text,
    VAL_CHAIN_KBN_NM text
)
;
copy order_record_17kami_19shimo(
    GOKI,
    JYUR,
    NOCD,
    JIKB,
    CHIK,
    KIKI,
    GYOS,
    KISC,
    EKIS,
    SEIH,
    NAIG,
    KETE,
    NOYM,
    URKB,
    KENSHU_YOTEI_DATE,
    JYKN,
    MITSU_SEIZO_GENKA,
    TODOFKN_CD,
    KOKUNAIGAI_KBN,
    VAL_CHAIN_KBN_CD,
    VAL_CHAIN_KBN_NM
)	
    from 'power_bi/order_record_17kami_19shimo.txt'
;

--受注実績
--データコピー
--受注実績20上期～先月
drop table order_record_20kami_lamo
;
create table order_record_20kami_lamo(
    GOKI text,
    JYUR text,
    NOCD text,
    JIKB text,
    CHIK text,
    KIKI text,
    GYOS text,
    KISC text,
    EKIS text,
    SEIH text,
    NAIG text,
    KETE text,
    NOYM text,
    URKB text,
    KENSHU_YOTEI_DATE text,
    JYKN text,
    MITSU_SEIZO_GENKA text,
    TODOFKN_CD text,
    KOKUNAIGAI_KBN text,
    VAL_CHAIN_KBN_CD text,
    VAL_CHAIN_KBN_NM text
)
;
copy order_record_20kami_lamo(
    GOKI,
    JYUR,
    NOCD,
    JIKB,
    CHIK,
    KIKI,
    GYOS,
    KISC,
    EKIS,
    SEIH,
    NAIG,
    KETE,
    NOYM,
    URKB,
    KENSHU_YOTEI_DATE,
    JYKN,
    MITSU_SEIZO_GENKA,
    TODOFKN_CD,
    KOKUNAIGAI_KBN,
    VAL_CHAIN_KBN_CD,
    VAL_CHAIN_KBN_NM
)	
    from 'power_bi/order_record_19shimo_lamo.txt' (delimiter '	', format csv, header true )
;

--受注実績
--データコピー
--受注実績　前月・今月
drop table order_record_lamo_thmo
;
create table order_record_lamo_thmo(
    GOKI text,
    JYUR text,
    NOCD text,
    JIKB text,
    CHIK text,
    KIKI text,
    GYOS text,
    KISC text,
    EKIS text,
    SEIH text,
    NAIG text,
    KETE text,
    NOYM text,
    URKB text,
    KENSHU_YOTEI_DATE text,
    JYKN text,
    MITSU_SEIZO_GENKA text,
    TODOFKN_CD text,
    KOKUNAIGAI_KBN text,
    VAL_CHAIN_KBN_CD text,
    VAL_CHAIN_KBN_NM text
)
;
copy order_record_lamo_thmo(
    GOKI,
    JYUR,
    NOCD,
    JIKB,
    CHIK,
    KIKI,
    GYOS,
    KISC,
    EKIS,
    SEIH,
    NAIG,
    KETE,
    NOYM,
    URKB,
    KENSHU_YOTEI_DATE,
    JYKN,
    MITSU_SEIZO_GENKA,
    TODOFKN_CD,
    KOKUNAIGAI_KBN,
    VAL_CHAIN_KBN_CD,
    VAL_CHAIN_KBN_NM
)	
    from 'power_bi/order_record_lamo_thmo.txt' (delimiter '	', format csv, header true )
;

--受注実績
--サマリーテーブルの作成
--テーブル名を変更するとPowerBIに影響が出るため注意

drop table order_record_summary;

create table order_record_summary as
select
    uor.GOKI,
    uor.JYUR,
    uor.KIKI,
    uor.GYOS,
    uor.KISC,
    uor.EKIS,
    uor.SEIH,
    uor.NAIG,
    uor.KETE,
    uor.NOYM,
    uor.URKB,
    uor.KENSHU_YOTEI_DATE,
    uor.JYKN, 
    uor.MITSU_SEIZO_GENKA, 
    uor.KOKUNAIGAI_KBN,
    uor.VAL_CHAIN_KBN_NM,
    jt.jigyoumei,
    ncm.TORI_SEI_KANJI,
    ccm.chsh,
    fcm.fknm,
    vkt.val_ktd,
    vkt.val_category,
    gcm.GYOSHU_SHO_NM,
    gcm.GYOSHU_DAI_NM,
    case when extract(month from uor.jyur) < 4 then extract(year from uor.jyur) -1
    else extract(year from uor.jyur) end as fy,
    substr(uor.goki, 1, 2) as check_sp,
    case
        when uor.KOKUNAIGAI_KBN = '1:KOKUNAI ' then '国内'
        when uor.KOKUNAIGAI_KBN = '2:KAIGAI  ' then '海外'
        else 'その他' end  as kokunai_kaigai_flag,
    case
        when substr(uor.goki, 1, 2) in ('S3','S5','S7','S9') then '工事あり'
        when substr(uor.goki, 1, 2) in ('S2','S4','S6','S8','ST') then '工事なし'
        else 'その他' end as koji_check,
    case
        when substr(uor.goki, 1, 2) in ('S2') then '1'
        when substr(uor.goki, 1, 2) in ('S4') then '2'
        when substr(uor.goki, 1, 2) in ('S6') then '3'
        when substr(uor.goki, 1, 2) in ('S8') then '4'
        when substr(uor.goki, 1, 2) in ('ST') then '5'
        when substr(uor.goki, 1, 2) in ('S3') then '6'
        when substr(uor.goki, 1, 2) in ('S5') then '7'
        when substr(uor.goki, 1, 2) in ('S7') then '8'
        when substr(uor.goki, 1, 2) in ('S9') then '9'
        else 'その他' end as sp_order
    
from(
select
    GOKI,
    cast(case
		 when length(JYUR)=0 then null
		 else JYUR
		 end
         as date),
    NOCD,
    JIKB,
    CHIK,
    KIKI,
    GYOS,
    KISC,
    EKIS,
    SEIH,
    NAIG,
    KETE,
    NOYM,
    URKB,
	cast(case
	when length(replace(KENSHU_YOTEI_DATE, ' ',''))=0 then null
	else KENSHU_YOTEI_DATE
	end
	as date),
    cast(to_number(JYKN, 'FM999,999,999,999.000')as integer)as JYKN,
    cast(to_number(MITSU_SEIZO_GENKA, 'FM999,999,999,999.000')as integer)as MITSU_SEIZO_GENKA,
    TODOFKN_CD,
    KOKUNAIGAI_KBN,
    VAL_CHAIN_KBN_CD,
    VAL_CHAIN_KBN_NM
from order_record_17kami_19shimo

union all

select
    GOKI,
    cast(case
		 when length(JYUR)=0 then null
		 else JYUR
		 end
         as date),
    NOCD,
    JIKB,
    CHIK,
    KIKI,
    GYOS,
    KISC,
    EKIS,
    SEIH,
    NAIG,
    KETE,
    NOYM,
    URKB,
	cast(case
	when length(replace(KENSHU_YOTEI_DATE, ' ',''))=0 then null
	else KENSHU_YOTEI_DATE
	end
	as date),
    cast(to_number(JYKN, 'FM999,999,999,999.000')as integer)as JYKN,
    cast(to_number(MITSU_SEIZO_GENKA, 'FM999,999,999,999.000')as integer)as MITSU_SEIZO_GENKA,
    TODOFKN_CD,
    KOKUNAIGAI_KBN,
    VAL_CHAIN_KBN_CD,
    VAL_CHAIN_KBN_NM
from order_record_20kami_lamo
where substr(jyur, 1,6) <> to_char(current_timestamp + '-1months', 'yyyymm')

union all

select
    GOKI,
    cast(case
		 when length(JYUR)=0 then null
		 else JYUR
		 end
         as date),
    NOCD,
    JIKB,
    CHIK,
    KIKI,
    GYOS,
    KISC,
    EKIS,
    SEIH,
    NAIG,
    KETE,
    NOYM,
    URKB,
	cast(case
	when length(replace(KENSHU_YOTEI_DATE, ' ',''))=0 then null
	else KENSHU_YOTEI_DATE
	end
	as date),
    cast(to_number(JYKN, 'FM999,999,999,999.000')as integer)as JYKN,
    cast(to_number(MITSU_SEIZO_GENKA, 'FM999,999,999,999.000')as integer)as MITSU_SEIZO_GENKA,
    TODOFKN_CD,
    KOKUNAIGAI_KBN,
    VAL_CHAIN_KBN_CD,
    VAL_CHAIN_KBN_NM
from order_record_lamo_thmo
--where substr(jyur, 1,6) = to_char(now(), 'yyyymm') 

)as uor

left join nounyuusaki_code_master as ncm
on uor.nocd = ncm.tori_cd

left join jigyou_kubun_table as jt
on uor.jikb = jt.jigyou_kubun

left join chiku_code_master as ccm
on uor.chik = ccm.chik

left join fuken_code_master as fcm
on uor.TODOFKN_CD = fcm.FKCD

left join valuechain_kubun_table as vkt
on uor.VAL_CHAIN_KBN_CD = vkt.VAL_CHAIN_KBN_CD

left join gyoushu_code_master as gcm
on uor.gyos =gcm.TORI_GYOSHU_CD_NONYU

where 
    uor.JIKB <> 'K' and
    uor.naig = '1' and
    vkt.val_category in ('04', '05', '06', '07')
;

--ダミーデータ

insert into order_record_summary(jyur, jykn, val_ktd) values ('2020-05-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2020-06-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2020-07-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2020-08-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2020-09-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2020-10-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2020-11-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2020-12-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2021-01-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2021-02-01', 0, '1.修理');
insert into order_record_summary(jyur, jykn, val_ktd) values ('2021-03-01', 0, '1.修理');


--5--日次当月累計のテーブル作成--------------------------------------------------
drop table order_record_daily_thmo
;
create table order_record_daily_thmo as

select
    jyur,
    sum(sum(jykn)) over (PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY DATE_TRUNC('DAY', jyur)) AS sum_thmo,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY jyur ASC) num_thmo
 
from order_record_summary

where
    to_char(jyur, 'yyyy-mm') = to_char(now(), 'yyyy-mm')

group by jyur

order by jyur asc
;

--6--日次前年同月累計のテーブル作成--------------------------------------------------
drop table order_record_daily_laye;

create table order_record_daily_laye as

select
    jyur,
    sum(sum(jykn)) over (PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY DATE_TRUNC('DAY', jyur)) AS sum_laye,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY jyur ASC) num_laye
 
from order_record_summary

where 
    to_char(jyur,'yyyy-mm') = to_char(current_timestamp + '-12months', 'yyyy-mm')

group by jyur

order by jyur asc
;

--7--日次前前年同月累計のテーブル作成--------------------------------------------------
drop table order_record_daily_2yea;

create table order_record_daily_2yea as

select
    jyur,
    sum(sum(jykn)) over (PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY DATE_TRUNC('DAY', jyur)) AS sum_2yea,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY jyur ASC) num_2yea
 
from order_record_summary

where 
    to_char(jyur,'yyyy-mm') = to_char(current_timestamp + '-24months', 'yyyy-mm')

group by jyur

order by jyur asc
;

--受注実績
--17上期累計テーブル作成
drop table order_record_monthly_17km
;
create table order_record_monthly_17km as

select
    cast(to_char(jyur, 'yyyy-mm')||'-01' as date) as jyur_month,
    sum(sum(jykn)) over (ORDER BY to_char(jyur, 'yyyy-mm')) AS sum_17km
	 
from order_record_summary

where
    jyur >= '2017-04-01' and jyur < '2017-10-01'

group by to_char(jyur, 'yyyy-mm')

order by to_char(jyur, 'yyyy-mm') asc
;

--受注実績
--18上期累計テーブル作成
drop table order_record_monthly_18km
;
create table order_record_monthly_18km as

select
    cast(to_char(jyur, 'yyyy-mm')||'-01' as date) as jyur_month,
    sum(sum(jykn)) over (ORDER BY to_char(jyur, 'yyyy-mm')) AS sum_18km
	 
from order_record_summary

where
    jyur >= '2018-04-01' and jyur < '2018-10-01'

group by to_char(jyur, 'yyyy-mm')

order by to_char(jyur, 'yyyy-mm') asc
;

--受注実績
--19上期累計テーブル作成
drop table order_record_monthly_19km
;
create table order_record_monthly_19km as

select
    cast(to_char(jyur, 'yyyy-mm')||'-01' as date) as jyur_month,
    sum(sum(jykn)) over (ORDER BY to_char(jyur, 'yyyy-mm')) AS sum_19km
	 
from order_record_summary

where
    jyur >= '2019-04-01' and jyur < '2019-10-01'

group by to_char(jyur, 'yyyy-mm')

order by to_char(jyur, 'yyyy-mm') asc
;

--受注実績
--20上期累計テーブル作成
drop table order_record_monthly_20km
;
create table order_record_monthly_20km as

select
    cast(to_char(jyur, 'yyyy-mm')||'-01' as date) as jyur_month,
    sum(sum(jykn)) over (ORDER BY to_char(jyur, 'yyyy-mm')) AS sum_20km
	 
from order_record_summary

where
    jyur >= '2020-04-01' and jyur <= cast(to_char(now(), 'yyyy-mm-dd') as date)

group by to_char(jyur, 'yyyy-mm')

order by to_char(jyur, 'yyyy-mm') asc
;

--11-17下期累計テーブル作成--------------------------------------------------
drop table order_record_monthly_17sm
;
create table order_record_monthly_17sm as

select
    jyur,
    sum(sum(jykn)) over (ORDER BY DATE_TRUNC('month', jyur)) AS sum_17sm
	 
from order_record_summary

where
    jyur >= '2017-10-01' and jyur < '2018-04-01'

group by jyur

order by jyur asc
;

--12--18下期累計テーブル作成--------------------------------------------------
drop table order_record_monthly_18sm
;
create table order_record_monthly_18sm as

select
    jyur,
    sum(sum(jykn)) over (ORDER BY DATE_TRUNC('month', jyur)) AS sum_18sm
	 
from order_record_summary

where
    jyur >= '2018-10-01' and jyur < '2019-04-01'

group by jyur

order by jyur asc
;
--13--19下期累計テーブル作成--------------------------------------------------
drop table order_record_monthly_19sm
;
create table order_record_monthly_19sm as

select
    jyur,
    sum(sum(jykn)) over (ORDER BY DATE_TRUNC('month', jyur)) AS sum_19sm
	 
from order_record_summary

where
    jyur >= '2019-10-01' and jyur < '2020-04-01'

group by jyur

order by jyur asc
;
--14--SP日次当月累計のテーブル作成--------------------------------------------------
drop table order_record_sp_daily_thmo
;
create table order_record_sp_daily_thmo as

select
    jyur,
    sum(sum(jykn)) over (PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY DATE_TRUNC('DAY', jyur)) AS sum_thmo,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY jyur ASC) num_thmo
 
from order_record_summary

where
    to_char(jyur, 'yyyy-mm') = to_char(now(), 'yyyy-mm') and
    koji_check not like 'その他'

group by jyur

order by jyur asc
;
--15--日次前年同月累計のテーブル作成--------------------------------------------------
drop table order_record_sp_daily_laye;

create table order_record_sp_daily_laye as

select
    jyur,
    sum(sum(jykn)) over (PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY DATE_TRUNC('DAY', jyur)) AS sum_laye,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY jyur ASC) num_laye
 
from order_record_summary

where 
    to_char(jyur,'yyyy-mm') = to_char(current_timestamp + '-12months', 'yyyy-mm') and
    koji_check not like 'その他'

group by jyur

order by jyur asc
;

--16--日次前前年同月累計のテーブル作成--------------------------------------------------
drop table order_record_sp_daily_2yea;

create table order_record_sp_daily_2yea as

select
    jyur,
    sum(sum(jykn)) over (PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY DATE_TRUNC('DAY', jyur)) AS sum_2yea,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', jyur) ORDER BY jyur ASC) num_2yea
 
from order_record_summary

where 
    to_char(jyur,'yyyy-mm') = to_char(current_timestamp + '-24months', 'yyyy-mm') and
    koji_check not like 'その他'

group by jyur

order by jyur asc
;

--●〇●販売実績●〇●-----------------------------------------------------------
--販売実績------------------------------------------
drop table hnbi_record_daily
;
create table hnbi_record_daily(
    JYGP text,--1
    GOKI text,--2
    JYCD text,--3
    NOCD text,--4
    KIKI text,--5
    CHIK text,--6
    NAIG text,--7
    SEIH text,--8
    URKB text,--9
    KENS text,--10
    GYOS text,--11
    KISC text,--12
    EKIS text,--13
    URGP text,--14
    KNGP text,--15
    SEEI text,--16
    URSU text,--17
    URKN text,--18
    JGCD text,--19
    SRYM text,--20
    CODEX text,--21
    FUKN text,--22
    KOUM text,--23
    KOKU text,--24
    URI_JIGYO_BA text,--25
    VAL_CHAIN_KBN_CD text,--26
    VAL_CHAIN_KBN_NM text,--27
    AFTER_BUZ_NM text,--28
    KNGP_GOKI text,--29
    LEASE_KBN text,--30
    PROJECT_NO text,--31
    PROJECT_NM text--32
)
;

copy hnbi_record_daily(
    JYGP,
    GOKI,
    JYCD,
    NOCD,
    KIKI,
    CHIK,
    NAIG,
    SEIH,
    URKB,
    KENS,
    GYOS,
    KISC,
    EKIS,
    URGP,
    KNGP,
    SEEI,
    URSU,
    URKN,
    JGCD,
    SRYM,
    CODEX,
    FUKN,
    KOUM,
    KOKU,
    URI_JIGYO_BA,
    VAL_CHAIN_KBN_CD,
    VAL_CHAIN_KBN_NM,
    AFTER_BUZ_NM,
    KNGP_GOKI,
    LEASE_KBN,
    PROJECT_NO,
    PROJECT_NM
) from 'power_bi/hnbi_record_daily.txt' (delimiter '	', format csv, header true )
;

delete from hnbi_record_daily
where jygp = '﻿'
;
update hnbi_record_daily set jygp = '' where jygp = '﻿'
;
--販売実績当月サマリー--------------------------------
drop table hnbi_record_summary
;
create table hnbi_record_summary as
select
    hrs.JYGP,
    hrs.GOKI,
    hrs.KIKI,
    hrs.NAIG,
    hrs.SEIH,
    hrs.URKB,
    hrs.KENS,
    hrs.KISC,
    hrs.EKIS,
    hrs.URGP,
    hrs.KNGP,
    hrs.SEEI,
    hrs.URSU,
    hrs.URKN,
    hrs.SRYM,
    hrs.CODEX,
    hrs.KOUM,
    hrs.KOKU,
    hrs.URI_JIGYO_BA,
	hrs.CATGRY_CD,
    hrs.VAL_CHAIN_KBN_NM,
    hrs.AFTER_BUZ_NM,
    hrs.KNGP_GOKI,
    hrs.LEASE_KBN,
    hrs.PROJECT_NO,
    hrs.PROJECT_NM,
    jt.jigyoumei,
    ncm.TORI_SEI_KANJI,
    ccm.chsh,
    fcm.fknm,
    vkt.val_ktd,
    gcm.GYOSHU_SHO_NM,
    gcm.GYOSHU_DAI_NM,
    substring(hrs.GOKI, 1,2) as check_jsp,
    case
        when substr(hrs.GOKI, 1, 2) in ('S3','S5','S7','S9') then '工事あり'
        when substr(hrs.GOKI, 1, 2) in ('S2','S4','S6','S8','ST') then '工事なし'
        else 'その他' end as koji_check,
    case
        when substr(hrs.GOKI, 1, 2) in ('S2') then '1'
        when substr(hrs.GOKI, 1, 2) in ('S4') then '2'
        when substr(hrs.GOKI, 1, 2) in ('S6') then '3'
        when substr(hrs.GOKI, 1, 2) in ('S8') then '4'
        when substr(hrs.GOKI, 1, 2) in ('ST') then '5'
        when substr(hrs.GOKI, 1, 2) in ('S3') then '6'
        when substr(hrs.GOKI, 1, 2) in ('S5') then '7'
        when substr(hrs.GOKI, 1, 2) in ('S7') then '8'
        when substr(hrs.GOKI, 1, 2) in ('S9') then '9'
		else 'その他' end as sp_order

from(
select
    cast(case
		 when length(replace(JYGP, ' ',''))=0 then null
	else JYGP
	end
	as date),
    GOKI,
    JYCD,
    NOCD,
    KIKI,
    CHIK,
    NAIG,
    SEIH,
    URKB,
    KENS,
    GYOS,
    KISC,
    EKIS,
    cast(case
		 when length(replace(URGP, ' ',''))=0 then null
	    else URGP
	    end
	    as date),
    cast(case
		 when length(replace(KNGP,  ' ',''))=0 then null
	    else KNGP
	    end
	    as date),
    SEEI,
    URSU,
    cast(to_number(URKN, 'FM999,999,999,999.000')as integer)as URKN, --売上金額
    JGCD,
    SRYM,
    CODEX,
    FUKN,
    KOUM,
    KOKU,
    URI_JIGYO_BA,
    VAL_CHAIN_KBN_CD,
	substring(VAL_CHAIN_KBN_CD from 1 for 2) as CATGRY_CD,
    VAL_CHAIN_KBN_NM,
    AFTER_BUZ_NM,
    KNGP_GOKI,
    LEASE_KBN,
    PROJECT_NO,
    PROJECT_NM
	
from
    hnbi_record_daily
)as hrs

left join nounyuusaki_code_master as ncm
on hrs.NOCD = ncm.tori_cd

left join jigyou_kubun_table as jt
on hrs.JGCD = jt.jigyou_kubun

left join chiku_code_master as ccm
on hrs.CHIK = ccm.chik

left join fuken_code_master as fcm
on hrs.FUKN = fcm.FKCD

left join valuechain_kubun_table as vkt
on hrs.VAL_CHAIN_KBN_CD = vkt.VAL_CHAIN_KBN_CD

left join gyoushu_code_master as gcm
on hrs.GYOS =gcm.TORI_GYOSHU_CD_NONYU

where
    NAIG = '1' and
    JGCD <> 'K' and
    CATGRY_CD in ('04', '05', '06', '07') and
	to_char(URGP, 'yyyy-mm') >= to_char(current_timestamp + '-1months', 'yyyy-mm')
;

--5--日次当月累計のテーブル作成--------------------------------------------------
drop table hnbi_record_daily_sum_thmo
;
create table hnbi_record_daily_sum_thmo as

select
    URGP,
    sum(sum(URKN)) over (PARTITION BY DATE_TRUNC('MONTH', URGP) ORDER BY DATE_TRUNC('DAY', URGP)) AS sum_thmo,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', URGP) ORDER BY URGP ASC) num_thmo
 
from hnbi_record_summary

where
    to_char(URGP, 'yyyy-mm') = to_char(now(), 'yyyy-mm')

group by URGP

order by URGP asc
;
--6--日次前月累計のテーブル作成--------------------------------------------------
drop table hnbi_record_daily_sum_lamo
;
create table hnbi_record_daily_sum_lamo as

select
    URGP,
    sum(sum(URKN)) over (PARTITION BY DATE_TRUNC('MONTH', URGP) ORDER BY DATE_TRUNC('DAY', URGP)) AS sum_lamo,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', URGP) ORDER BY URGP ASC) num_lamo
 
from hnbi_record_summary

where
    to_char(URGP, 'yyyy-mm') = to_char(current_timestamp + '-1months', 'yyyy-mm')

group by URGP

order by URGP asc
;

--7--日次前年同月累計のテーブル作成--------------------------------------------------
drop table hnbi_record_daily_sum_laye
;
create table hnbi_record_daily_sum_laye as

select
    UYMD,
    sum(sum(UKIN)) over (PARTITION BY DATE_TRUNC('MONTH', UYMD) ORDER BY DATE_TRUNC('DAY', UYMD)) AS sum_laye,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', UYMD) ORDER BY UYMD ASC) num_laye
 
from urag_seizo_summary

where
     to_char(UYMD,'yyyy-mm') = to_char(current_timestamp + '-12months', 'yyyy-mm')

group by UYMD

order by UYMD asc
;

--8--日次前々年同月累計のテーブル作成--------------------------------------------------
drop table hnbi_record_daily_sum_2yea
;
create table hnbi_record_daily_sum_2yea as

select
    UYMD,
    sum(sum(UKIN)) over (PARTITION BY DATE_TRUNC('MONTH', UYMD) ORDER BY DATE_TRUNC('DAY', UYMD)) AS sum_2yea,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', UYMD) ORDER BY UYMD ASC) num_2yea
 
from urag_seizo_summary

where
     to_char(UYMD,'yyyy-mm') = to_char(current_timestamp + '-24months', 'yyyy-mm')

group by UYMD

order by UYMD asc
;

--●〇●新規引合●〇●-----------------------------------------------------------
--新規引合テーブル 17年度上期～19年度上期----------

drop table shinki_hikiai_17km_19km
;

create table shinki_hikiai_17km_19km(
    HIKIAI_NO text,--1
    HIKIAI_DATE text,--2
    TANTO_CD text,--3
    SHAIN_NM text,--4
    CHIKU_CD text,--5
    CHIKU_NM text,--6
    SEHIN_SHUBETSU_CD text,--7
    SEHIN_SHUBETSU_NM text,--8
    TORI_CD_NONYU text,--9
    TORI_NM_NONYU_SEI text,--10
    TORI_TODOFKN_CD_NONYU text,--11
    TODOFKN_NM_JP text,--12
    TORI_KIBO_CD_NONYU text,--13
    KIBO_NM text,--14
    KOKUNAIGAI_KBN text,--15
    KOKUNAIGAI_KBN_NM text,--16
    TORI_GYOSHU_CD_NONYU text,--17
    GYOSHU_SHO_NM text,--18
    NAIHAN_GAIHAN_KBN_CD text,--19
    NAIHAN_GAIHAN_KBN_NM text,--20
    KISHU_CD text,--21
    SEHIN_NM_EIGYO text,--22
    HIKIAI_RANK_CD text,--23
    JUCHU_YOTEI_KIN text,--24
    KIBO_NOKI_DATE text,--25
    JUCHU_YOTEI_DATE text,--26
    KENSHU_YOTEI_DATE text,--27
    KECHAKU_DATE text,--28
    KACHIMAKE_KBN_CD text,--29
    VAL_CHAIN_KBN_CD text,--30
    VAL_CHAIN_KBN_NM text,--31
    AFTER_BUZ_NM text--32
)
;

copy shinki_hikiai_17km_19km(
    HIKIAI_NO, --引合No
    HIKIAI_DATE, --引合日
    TANTO_CD, --担当者コード
    SHAIN_NM, --担当者名
    CHIKU_CD, --地区コード
    CHIKU_NM, --地区名称
    SEHIN_SHUBETSU_CD, --製品種別コード
    SEHIN_SHUBETSU_NM, --製品種別名称
    TORI_CD_NONYU, --取引先コード(納入先)
    TORI_NM_NONYU_SEI, --取引先名称(納入先)正式
    TORI_TODOFKN_CD_NONYU, --国都道府県コード（納入先）
    TODOFKN_NM_JP, --都道府県、国
    TORI_KIBO_CD_NONYU, --規模コード（納入先）
    KIBO_NM, --規模名称
    KOKUNAIGAI_KBN, --国内外区分コード
    KOKUNAIGAI_KBN_NM, --国内外区分名称
    TORI_GYOSHU_CD_NONYU, --業種コード（納入先）
    GYOSHU_SHO_NM, --業種詳細名称
    NAIHAN_GAIHAN_KBN_CD, --内販外販区分コード
    NAIHAN_GAIHAN_KBN_NM, --内販外販区分名称
    KISHU_CD, --機種コード
    SEHIN_NM_EIGYO, --製品名称（営業）
    HIKIAI_RANK_CD, --引合ランクコード
    JUCHU_YOTEI_KIN, --受注予定金額
    KIBO_NOKI_DATE, --希望納期日
    JUCHU_YOTEI_DATE, --受注予定日
    KENSHU_YOTEI_DATE, --検収予定日
    KECHAKU_DATE, --決着日
    KACHIMAKE_KBN_CD, --勝負区分コード
    VAL_CHAIN_KBN_CD, --バリューチェーン区分コード
    VAL_CHAIN_KBN_NM, --バリューチェーン区分名称
    AFTER_BUZ_NM --アフタービジネス名称
 )
    from 'power_bi/shinki_hikiai_17km_19km.txt' (delimiter '	', format csv, header true )
;

--新規引合テーブル 19年度下期～----------
drop table shinki_hikiai_19sm
;

create table shinki_hikiai_19sm(
    HIKIAI_NO text,--1
    HIKIAI_DATE text,--2
    TANTO_CD text,--3
    SHAIN_NM text,--4
    CHIKU_CD text,--5
    CHIKU_NM text,--6
    SEHIN_SHUBETSU_CD text,--7
    SEHIN_SHUBETSU_NM text,--8
    TORI_CD_NONYU text,--9
    TORI_NM_NONYU_SEI text,--10
    TORI_TODOFKN_CD_NONYU text,--11
    TODOFKN_NM_JP text,--12
    TORI_KIBO_CD_NONYU text,--13
    KIBO_NM text,--14
    KOKUNAIGAI_KBN text,--15
    KOKUNAIGAI_KBN_NM text,--16
    TORI_GYOSHU_CD_NONYU text,--17
    GYOSHU_SHO_NM text,--18
    NAIHAN_GAIHAN_KBN_CD text,--19
    NAIHAN_GAIHAN_KBN_NM text,--20
    KISHU_CD text,--21
    SEHIN_NM_EIGYO text,--22
    HIKIAI_RANK_CD text,--23
    JUCHU_YOTEI_KIN text,--24
    KIBO_NOKI_DATE text,--25
    JUCHU_YOTEI_DATE text,--26
    KENSHU_YOTEI_DATE text,--27
    KECHAKU_DATE text,--28
    KACHIMAKE_KBN_CD text,--29
    VAL_CHAIN_KBN_CD text,--30
    VAL_CHAIN_KBN_NM text,--31
    AFTER_BUZ_NM text--32
)
;

copy shinki_hikiai_19sm(
    HIKIAI_NO, --引合No
    HIKIAI_DATE, --引合日
    TANTO_CD, --担当者コード
    SHAIN_NM, --担当者名
    CHIKU_CD, --地区コード
    CHIKU_NM, --地区名称
    SEHIN_SHUBETSU_CD, --製品種別コード
    SEHIN_SHUBETSU_NM, --製品種別名称
    TORI_CD_NONYU, --取引先コード(納入先)
    TORI_NM_NONYU_SEI, --取引先名称(納入先)正式
    TORI_TODOFKN_CD_NONYU, --国都道府県コード（納入先）
    TODOFKN_NM_JP, --都道府県、国
    TORI_KIBO_CD_NONYU, --規模コード（納入先）
    KIBO_NM, --規模名称
    KOKUNAIGAI_KBN, --国内外区分コード
    KOKUNAIGAI_KBN_NM, --国内外区分名称
    TORI_GYOSHU_CD_NONYU, --業種コード（納入先）
    GYOSHU_SHO_NM, --業種詳細名称
    NAIHAN_GAIHAN_KBN_CD, --内販外販区分コード
    NAIHAN_GAIHAN_KBN_NM, --内販外販区分名称
    KISHU_CD, --機種コード
    SEHIN_NM_EIGYO, --製品名称（営業）
    HIKIAI_RANK_CD, --引合ランクコード
    JUCHU_YOTEI_KIN, --受注予定金額
    KIBO_NOKI_DATE, --希望納期日
    JUCHU_YOTEI_DATE, --受注予定日
    KENSHU_YOTEI_DATE, --検収予定日
    KECHAKU_DATE, --決着日
    KACHIMAKE_KBN_CD, --勝負区分コード
    VAL_CHAIN_KBN_CD, --バリューチェーン区分コード
    VAL_CHAIN_KBN_NM, --バリューチェーン区分名称
    AFTER_BUZ_NM --アフタービジネス名称
 )
    from 'power_bi/shinki_hikiai_19sm.txt'
;
--新規引合サマリーテーブルの作成------------------------------
drop table shinki_hikiai_summary
;
create table shinki_hikiai_summary as
(
select 
    ush.HIKIAI_NO, --引合No
    ush.HIKIAI_DATE, --引合日
    ush.SHAIN_NM, --担当者名
    ush.CHIKU_NM, --地区名称
    ush.SEHIN_SHUBETSU_NM, --製品種別名称
    ush.TORI_NM_NONYU_SEI, --取引先名称(納入先)正式
    ush.TODOFKN_NM_JP, --都道府県、国
    ush.KIBO_NM, --規模名称
    ush.KOKUNAIGAI_KBN_NM, --国内外区分名称
    ush.TORI_GYOSHU_CD_NONYU, --業種コード（納入先）
    ush.GYOSHU_SHO_NM, --業種詳細名称
    ush.NAIHAN_GAIHAN_KBN_CD, --内販外販区分名称
    ush.KISHU_CD, --機種コード
    ush.SEHIN_NM_EIGYO, --製品名称（営業）
    ush.HIKIAI_RANK_CD, --引合ランクコード
    ush.JUCHU_YOTEI_KIN, --受注予定金額
    ush.KACHIMAKE_KBN_CD, --勝負区分コード
    ush.VAL_CHAIN_KBN_CD, --バリューチェーン区分コード
    ush.VAL_CHAIN_KBN_NM, --バリューチェーン区分名称
    ush.AFTER_BUZ_NM, --アフタービジネス名称
	ush.VAL_CATEGORY,
	vkt.val_ktd, --活動系名称
	concat(ush.HIKIAI_NO, '-', vkt.val_ktd) as hikiai_no_val_ktd	
from
    (
	select
	HIKIAI_NO, --引合No
    cast(case
		 when length(replace(HIKIAI_DATE, ' ',''))=0 then null
	else HIKIAI_DATE
	end
	as date), --引合日
    SHAIN_NM, --担当者名
    CHIKU_NM, --地区名称
    trim(SEHIN_SHUBETSU_NM) as SEHIN_SHUBETSU_NM, --製品種別名称
    TORI_NM_NONYU_SEI, --取引先名称(納入先)正式
    TODOFKN_NM_JP, --都道府県、国
    KIBO_NM, --規模名称
    KOKUNAIGAI_KBN_NM, --国内外区分名称
    TORI_GYOSHU_CD_NONYU, --業種コード（納入先）
    GYOSHU_SHO_NM, --業種詳細名称
    NAIHAN_GAIHAN_KBN_CD, --内販外販区分
    KISHU_CD, --機種コード
    SEHIN_NM_EIGYO, --製品名称（営業）
    trim(HIKIAI_RANK_CD) as HIKIAI_RANK_CD, --引合ランクコード
    cast(to_number(JUCHU_YOTEI_KIN, 'FM999,999,999,999.000')as integer)as JUCHU_YOTEI_KIN, --受注予定金額  
    trim(KACHIMAKE_KBN_CD) as KACHIMAKE_KBN_CD, --勝負区分コード
    trim(VAL_CHAIN_KBN_CD) as VAL_CHAIN_KBN_CD, --バリューチェーン区分コード
    VAL_CHAIN_KBN_NM, --バリューチェーン区分名称
    AFTER_BUZ_NM, --アフタービジネス名称
	substr(VAL_CHAIN_KBN_CD, 1,2) as VAL_CATEGORY

	from
		shinki_hikiai_17km_19km
	where	
		trim(SEHIN_SHUBETSU_NM)  IN  ('マシニングセンタ', '研削盤', '切削機') and
		NAIHAN_GAIHAN_KBN_CD like '1' and
		substr(trim(VAL_CHAIN_KBN_CD), 1,2) in ('04', '05', '06', '07') 		
	union all
		
	select
	HIKIAI_NO, --引合No
    cast(case
		 when length(replace(HIKIAI_DATE, ' ',''))=0 then null
	else HIKIAI_DATE
	end
	as date), --引合日
    SHAIN_NM, --担当者名
    CHIKU_NM, --地区名称
    trim(SEHIN_SHUBETSU_NM) as SEHIN_SHUBETSU_NM , --製品種別名称
    TORI_NM_NONYU_SEI, --取引先名称(納入先)正式
    TODOFKN_NM_JP, --都道府県、国
    KIBO_NM, --規模名称
    KOKUNAIGAI_KBN_NM, --国内外区分名称
    TORI_GYOSHU_CD_NONYU, --業種コード（納入先）
    GYOSHU_SHO_NM, --業種詳細名称
    NAIHAN_GAIHAN_KBN_CD, --内販外販区分
    KISHU_CD, --機種コード
    SEHIN_NM_EIGYO, --製品名称（営業）
    trim(HIKIAI_RANK_CD) as HIKIAI_RANK_CD, --引合ランクコード
    cast(to_number(JUCHU_YOTEI_KIN, 'FM999,999,999,999.000')as integer)as JUCHU_YOTEI_KIN, --受注予定金額  
    trim(KACHIMAKE_KBN_CD) as KACHIMAKE_KBN_CD, --勝負区分コード
    trim(VAL_CHAIN_KBN_CD) as VAL_CHAIN_KBN_CD, --バリューチェーン区分コード
    VAL_CHAIN_KBN_NM, --バリューチェーン区分名称
    AFTER_BUZ_NM, --アフタービジネス名称
	substr(VAL_CHAIN_KBN_CD, 1,2) as VAL_CATEGORY
	from
		shinki_hikiai_19sm
	where
		trim(SEHIN_SHUBETSU_NM)  IN  ('マシニングセンタ', '研削盤', '切削機') and
		NAIHAN_GAIHAN_KBN_CD like '1' and
		substr(trim(VAL_CHAIN_KBN_CD), 1,2) in ('04', '05', '06', '07')
	)as ush
	
left join valuechain_kubun_table as vkt
on ush.VAL_CHAIN_KBN_CD = vkt.VAL_CHAIN_KBN_CD
	
where
	ush.HIKIAI_RANK_CD like 'A' or ush.HIKIAI_RANK_CD like 'AA' or ush.HIKIAI_RANK_CD like 'AS' or ush.HIKIAI_RANK_CD like 'BA'
)
;

--日次累計当月・全体---------------------------------------------------------
drop table shinki_hikiai_daily_thmo_znti
;
create table shinki_hikiai_daily_thmo_znti as

select
    HIKIAI_DATE,
    sum(count(hikiai_no_val_ktd)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_tm,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_tm

from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE, 'yyyy-mm') = to_char(now(), 'yyyy-mm')

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前月・全体---------------------------------------------------------
drop table shinki_hikiai_daily_lamo_znti
;
create table shinki_hikiai_daily_lamo_znti as

select
    HIKIAI_DATE,
    sum(count(hikiai_no_val_ktd)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_lm,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_lm

from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE, 'yyyy-mm') = to_char(current_timestamp + '-1months', 'yyyy-mm')

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前年同月・全体----------------------------------------------------------
drop table shinki_hikiai_daily_laye_znti
;
create table shinki_hikiai_daily_laye_znti as

select
    HIKIAI_DATE,
    sum(count(hikiai_no_val_ktd)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_ly,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_ly

 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE,'yyyy-mm') = to_char(current_timestamp + '-12months', 'yyyy-mm')

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前々年同月・全体------------------------------------------------------
drop table shinki_hikiai_daily_2yea_znti
;
create table shinki_hikiai_daily_2yea_znti as

select
    HIKIAI_DATE,
    sum(count(hikiai_no_val_ktd)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_2y,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_2y
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE,'yyyy-mm') = to_char(current_timestamp + '-24months', 'yyyy-mm') 

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;
--月次累計19年・全体----------------------------------------------
drop table shinki_hikiai_20zt
;
create table shinki_hikiai_20zt as

select
    HIKIAI_DATE,
    sum(count(hikiai_no_val_ktd)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_20zt
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2020-04-01' and HIKIAI_DATE < '2021-04-01' 

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年・全体----------------------------------------------
drop table shinki_hikiai_19zt
;
create table shinki_hikiai_19zt as

select
    HIKIAI_DATE,
    sum(count(hikiai_no_val_ktd)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19zt
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2020-04-01' 

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年・全体----------------------------------------------
drop table shinki_hikiai_18zt
;
create table shinki_hikiai_18zt as

select
    HIKIAI_DATE,
    sum(count(hikiai_no_val_ktd)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18zt
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2019-04-01'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年・全体----------------------------------------------
drop table shinki_hikiai_17zt
;
create table shinki_hikiai_17zt as

select
    HIKIAI_DATE,
    sum(count(hikiai_no_val_ktd)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17zt
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2018-04-01'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;

--月次累計19年上期パーツ----------------------------------------------
drop table shinki_hikiai_19km_ztpart
;
create table shinki_hikiai_19km_ztpart as

select
    HIKIAI_DATE,
    sum(count(distinct hikiai_no_val_ktd)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期パーツ----------------------------------------------
drop table shinki_hikiai_18km_ztpart
;
create table shinki_hikiai_18km_ztpart as

select
    HIKIAI_DATE,
    sum(count(distinct hikiai_no_val_ktd)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期パーツ----------------------------------------------
drop table shinki_hikiai_17km_ztpart
;
create table shinki_hikiai_17km_ztpart as

select
    HIKIAI_DATE,
    sum(count(distinct hikiai_no_val_ktd)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年上期OH----------------------------------------------
drop table shinki_hikiai_19km_ztOH
;
create table shinki_hikiai_19km_ztOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期OH----------------------------------------------
drop table shinki_hikiai_18km_ztOH
;
create table shinki_hikiai_18km_ztOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期OH----------------------------------------------
drop table shinki_hikiai_17km_ztOH
;
create table shinki_hikiai_17km_ztOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年上期改造----------------------------------------------
drop table shinki_hikiai_19km_ztkai
;
create table shinki_hikiai_19km_ztkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期改造----------------------------------------------
drop table shinki_hikiai_18km_ztkai
;
create table shinki_hikiai_18km_ztkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期改造----------------------------------------------
drop table shinki_hikiai_17km_ztkai
;
create table shinki_hikiai_17km_ztkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--下期-------------------------------------------------------------
--月次累計19年下期パーツ----------------------------------------------
drop table shinki_hikiai_19sm_ztpart
;
create table shinki_hikiai_19sm_ztpart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期パーツ----------------------------------------------
drop table shinki_hikiai_18sm_ztpart
;
create table shinki_hikiai_18sm_ztpart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期パーツ----------------------------------------------
drop table shinki_hikiai_17sm_ztpart
;
create table shinki_hikiai_17sm_ztpart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年下期OH----------------------------------------------
drop table shinki_hikiai_19sm_ztOH
;
create table shinki_hikiai_19sm_ztOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期OH----------------------------------------------
drop table shinki_hikiai_18sm_ztOH
;
create table shinki_hikiai_18sm_ztOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期OH----------------------------------------------
drop table shinki_hikiai_17sm_ztOH
;
create table shinki_hikiai_17sm_ztOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年下期改造----------------------------------------------
drop table shinki_hikiai_19sm_ztkai
;
create table shinki_hikiai_19sm_ztkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期改造----------------------------------------------
drop table shinki_hikiai_18sm_ztkai
;
create table shinki_hikiai_18sm_ztkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期改造----------------------------------------------
drop table shinki_hikiai_17sm_ztkai
;
create table shinki_hikiai_17sm_ztkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--●研削盤●-------------------------------------------------------------------
--日次累計当月・研削盤---------------------------------------------------------
drop table shinki_hikiai_daily_thmo_gr
;
create table shinki_hikiai_daily_thmo_gr as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_tm,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_tm

from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE, 'yyyy-mm') = to_char(now(), 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like '研削盤%'

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前月・研削盤---------------------------------------------------------
drop table shinki_hikiai_daily_lamo_gr
;
create table shinki_hikiai_daily_lamo_gr as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_lm,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_lm

from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE, 'yyyy-mm') = to_char(current_timestamp + '-1months', 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like '研削盤%'

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前年同月・研削盤----------------------------------------------------------
drop table shinki_hikiai_daily_laye_gr
;
create table shinki_hikiai_daily_laye_gr as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_ly,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_ly

 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE,'yyyy-mm') = to_char(current_timestamp + '-12months', 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like '研削盤%'

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前々年同月・研削盤------------------------------------------------------
drop table shinki_hikiai_daily_2yea_gr
;
create table shinki_hikiai_daily_2yea_gr as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_2y,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_2y
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE,'yyyy-mm') = to_char(current_timestamp + '-24months', 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like '研削盤%' 

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;
--月次累計19年上期パーツ----------------------------------------------
drop table shinki_hikiai_19km_grpart
;
create table shinki_hikiai_19km_grpart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期パーツ----------------------------------------------
drop table shinki_hikiai_18km_grpart
;
create table shinki_hikiai_18km_grpart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期パーツ----------------------------------------------
drop table shinki_hikiai_17km_grpart
;
create table shinki_hikiai_17km_grpart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年上期OH----------------------------------------------
drop table shinki_hikiai_19km_grOH
;
create table shinki_hikiai_19km_grOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期OH----------------------------------------------
drop table shinki_hikiai_18km_grOH
;
create table shinki_hikiai_18km_grOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期OH----------------------------------------------
drop table shinki_hikiai_17km_grOH
;
create table shinki_hikiai_17km_grOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年上期改造----------------------------------------------
drop table shinki_hikiai_19km_grkai
;
create table shinki_hikiai_19km_grkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期改造----------------------------------------------
drop table shinki_hikiai_18km_grkai
;
create table shinki_hikiai_18km_grkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期改造----------------------------------------------
drop table shinki_hikiai_17km_grkai
;
create table shinki_hikiai_17km_grkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--下期-------------------------------------------------------------
--月次累計19年下期パーツ----------------------------------------------
drop table shinki_hikiai_19sm_grpart
;
create table shinki_hikiai_19sm_grpart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期パーツ----------------------------------------------
drop table shinki_hikiai_18sm_grpart
;
create table shinki_hikiai_18sm_grpart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期パーツ----------------------------------------------
drop table shinki_hikiai_17sm_grpart
;
create table shinki_hikiai_17sm_grpart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年下期OH----------------------------------------------
drop table shinki_hikiai_19sm_grOH
;
create table shinki_hikiai_19sm_grOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期OH----------------------------------------------
drop table shinki_hikiai_18sm_grOH
;
create table shinki_hikiai_18sm_grOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期OH----------------------------------------------
drop table shinki_hikiai_17sm_grOH
;
create table shinki_hikiai_17sm_grOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年下期改造----------------------------------------------
drop table shinki_hikiai_19sm_grkai
;
create table shinki_hikiai_19sm_grkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期改造----------------------------------------------
drop table shinki_hikiai_18sm_grkai
;
create table shinki_hikiai_18sm_grkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期改造----------------------------------------------
drop table shinki_hikiai_17sm_grkai
;
create table shinki_hikiai_17sm_grkai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    SEHIN_SHUBETSU_NM like '研削盤%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--●切削機●-----------------------------------------------------------------------
--日次累計当月・切削機---------------------------------------------------------
drop table shinki_hikiai_daily_thmo_cu
;
create table shinki_hikiai_daily_thmo_cu as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_tm,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_tm
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE, 'yyyy-mm') = to_char(now(), 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like '切削機%'

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前月・切削機----------------------------------------------------------
drop table shinki_hikiai_daily_lamo_cu
;
create table shinki_hikiai_daily_lamo_cu as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_lm,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_lm
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE,'yyyy-mm') = to_char(current_timestamp + '-1months', 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like '切削機%'

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前年同月・切削機----------------------------------------------------------
drop table shinki_hikiai_daily_laye_cu
;
create table shinki_hikiai_daily_laye_cu as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_ly,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_ly
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE,'yyyy-mm') = to_char(current_timestamp + '-12months', 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like '切削機%'

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前々年同月・切削機------------------------------------------------------
drop table shinki_hikiai_daily_2yea_cu
;
create table shinki_hikiai_daily_2yea_cu as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_2y,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_2y
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE,'yyyy-mm') = to_char(current_timestamp + '-24months', 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like '切削機%' 

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;
--月次累計19年上期パーツ----------------------------------------------
drop table shinki_hikiai_19km_cupart
;
create table shinki_hikiai_19km_cupart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期パーツ----------------------------------------------
drop table shinki_hikiai_18km_cupart
;
create table shinki_hikiai_18km_cupart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期パーツ----------------------------------------------
drop table shinki_hikiai_17km_cupart
;
create table shinki_hikiai_17km_cupart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年上期OH----------------------------------------------
drop table shinki_hikiai_19km_cuOH
;
create table shinki_hikiai_19km_cuOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期OH----------------------------------------------
drop table shinki_hikiai_18km_cuOH
;
create table shinki_hikiai_18km_cuOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期OH----------------------------------------------
drop table shinki_hikiai_17km_cuOH
;
create table shinki_hikiai_17km_cuOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年上期改造----------------------------------------------
drop table shinki_hikiai_19km_cukai
;
create table shinki_hikiai_19km_cukai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期改造----------------------------------------------
drop table shinki_hikiai_18km_cukai
;
create table shinki_hikiai_18km_cukai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期改造----------------------------------------------
drop table shinki_hikiai_17km_cukai
;
create table shinki_hikiai_17km_cukai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--下期-------------------------------------------------------------
--月次累計19年下期パーツ----------------------------------------------
drop table shinki_hikiai_19sm_cupart
;
create table shinki_hikiai_19sm_cupart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期パーツ----------------------------------------------
drop table shinki_hikiai_18sm_cupart
;
create table shinki_hikiai_18sm_cupart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期パーツ----------------------------------------------
drop table shinki_hikiai_17sm_cupart
;
create table shinki_hikiai_17sm_cupart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年下期OH----------------------------------------------
drop table shinki_hikiai_19sm_cuOH
;
create table shinki_hikiai_19sm_cuOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期OH----------------------------------------------
drop table shinki_hikiai_18sm_cuOH
;
create table shinki_hikiai_18sm_cuOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期OH----------------------------------------------
drop table shinki_hikiai_17sm_cuOH
;
create table shinki_hikiai_17sm_cuOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年下期改造----------------------------------------------
drop table shinki_hikiai_19sm_cukai
;
create table shinki_hikiai_19sm_cukai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期改造----------------------------------------------
drop table shinki_hikiai_18sm_cukai
;
create table shinki_hikiai_18sm_cukai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期改造----------------------------------------------
drop table shinki_hikiai_17sm_cukai
;
create table shinki_hikiai_17sm_cukai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    SEHIN_SHUBETSU_NM like '切削機%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--●マシニング●----------------------------------------------------------
--日次累計当月・切削機---------------------------------------------------------
drop table shinki_hikiai_daily_thmo_ma
;
create table shinki_hikiai_daily_thmo_ma as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_tm,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_tm
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE, 'yyyy-mm') = to_char(now(), 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like 'マシニング%'

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前月・切削機---------------------------------------------------------
drop table shinki_hikiai_daily_lamo_ma
;
create table shinki_hikiai_daily_lamo_ma as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_lm,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_lm
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE, 'yyyy-mm') = to_char(current_timestamp + '-1months', 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like 'マシニング%'

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前年同月・マシニング----------------------------------------------------------
drop table shinki_hikiai_daily_laye_ma
;
create table shinki_hikiai_daily_laye_ma as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_ly,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_ly
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE,'yyyy-mm') = to_char(current_timestamp + '-12months', 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like 'マシニング%'

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;

--日次累計前々年同月・マシニング------------------------------------------------------
drop table shinki_hikiai_daily_2yea_ma
;
create table shinki_hikiai_daily_2yea_ma as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY DATE_TRUNC('DAY', HIKIAI_DATE)) AS count_2y,
    ROW_NUMBER() OVER(PARTITION BY DATE_TRUNC('MONTH', HIKIAI_DATE) ORDER BY HIKIAI_DATE ASC) num_2y
 
from shinki_hikiai_summary

where 
    to_char(HIKIAI_DATE,'yyyy-mm') = to_char(current_timestamp + '-24months', 'yyyy-mm') and
    SEHIN_SHUBETSU_NM like 'マシニング%' 

group by HIKIAI_DATE
order by HIKIAI_DATE asc
;
--月次累計19年上期パーツ----------------------------------------------
drop table shinki_hikiai_19km_mapart
;
create table shinki_hikiai_19km_mapart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期パーツ----------------------------------------------
drop table shinki_hikiai_18km_mapart
;
create table shinki_hikiai_18km_mapart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期パーツ----------------------------------------------
drop table shinki_hikiai_17km_mapart
;
create table shinki_hikiai_17km_mapart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年上期OH----------------------------------------------
drop table shinki_hikiai_19km_maOH
;
create table shinki_hikiai_19km_maOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期OH----------------------------------------------
drop table shinki_hikiai_18km_maOH
;
create table shinki_hikiai_18km_maOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期OH----------------------------------------------
drop table shinki_hikiai_17km_maOH
;
create table shinki_hikiai_17km_maOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年上期改造----------------------------------------------
drop table shinki_hikiai_19km_makai
;
create table shinki_hikiai_19km_makai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-04-01' and HIKIAI_DATE < '2019-10-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年上期改造----------------------------------------------
drop table shinki_hikiai_18km_makai
;
create table shinki_hikiai_18km_makai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-04-01' and HIKIAI_DATE < '2018-10-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年上期改造----------------------------------------------
drop table shinki_hikiai_17km_makai
;
create table shinki_hikiai_17km_makai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17km
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-04-01' and HIKIAI_DATE < '2017-10-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--下期-------------------------------------------------------------
--月次累計19年下期パーツ----------------------------------------------
drop table shinki_hikiai_19sm_mapart
;
create table shinki_hikiai_19sm_mapart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期パーツ----------------------------------------------
drop table shinki_hikiai_18sm_mapart
;
create table shinki_hikiai_18sm_mapart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期パーツ----------------------------------------------
drop table shinki_hikiai_17sm_mapart
;
create table shinki_hikiai_17sm_mapart as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%パーツ%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年下期OH----------------------------------------------
drop table shinki_hikiai_19sm_maOH
;
create table shinki_hikiai_19sm_maOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期OH----------------------------------------------
drop table shinki_hikiai_18sm_maOH
;
create table shinki_hikiai_18sm_maOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期OH----------------------------------------------
drop table shinki_hikiai_17sm_maOH
;
create table shinki_hikiai_17sm_maOH as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%OH%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計19年下期改造----------------------------------------------
drop table shinki_hikiai_19sm_makai
;
create table shinki_hikiai_19sm_makai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_19sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2019-10-01' and HIKIAI_DATE < '2020-04-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計18年下期改造----------------------------------------------
drop table shinki_hikiai_18sm_makai
;
create table shinki_hikiai_18sm_makai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_18sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2018-10-01' and HIKIAI_DATE < '2019-04-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc
;
--月次累計17年下期改造----------------------------------------------
drop table shinki_hikiai_17sm_makai
;
create table shinki_hikiai_17sm_makai as

select
    HIKIAI_DATE,
    sum(count(distinct HIKIAI_NO)) over (ORDER BY DATE_TRUNC('month', HIKIAI_DATE)) AS count_17sm
	 
from shinki_hikiai_summary

where
    HIKIAI_DATE >= '2017-10-01' and HIKIAI_DATE < '2018-04-01' and
    SEHIN_SHUBETSU_NM like 'マシニング%' and
    val_ktd like '%改造%'

group by HIKIAI_DATE

order by HIKIAI_DATE asc


;
